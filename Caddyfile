# ==============================================
# Caddyfile for pornguru.cam
# FrankenPHP with automatic HTTPS
# ==============================================

{
    # Global options
    frankenphp
    
    # Enable HTTP/3
    servers {
        protocols h1 h2 h3
    }
    
    # Email for Let's Encrypt notifications
    email admin@pornguru.cam
}

# Main domain with automatic HTTPS
pornguru.cam, www.pornguru.cam {
    # Redirect www to non-www
    @www host www.pornguru.cam
    redir @www https://pornguru.cam{uri} permanent

    # Document root
    root * /app/public

    # Encode responses with gzip/zstd
    encode zstd gzip

    # Security headers
    header {
        # HSTS - force HTTPS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"
        # XSS protection
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"
        # Remove server identification
        -Server
    }

    # Handle Laravel with FrankenPHP (standard request-per-process mode)
    # No worker mode - works with vanilla Laravel out of the box
    php_server

    # Dynamic pages - NO cache (content updates every 30 seconds)
    @dynamic {
        not path /build/* *.css *.js *.ico *.gif *.jpg *.jpeg *.png *.svg *.webp *.woff *.woff2 *.ttf *.eot
    }
    header @dynamic Cache-Control "no-cache, no-store, must-revalidate"
    header @dynamic Pragma "no-cache"

    # Build assets (versioned by Vite, cache forever)
    @build {
        path /build/*
    }
    header @build Cache-Control "public, max-age=31536000, immutable"

    # Static assets (fonts, favicons)
    @static {
        path *.ico *.woff *.woff2 *.ttf *.eot
    }
    header @static Cache-Control "public, max-age=86400"

    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
        }
        format json
    }
}

# Local development fallback (when SERVER_NAME is set to :80)
:80 {
    root * /app/public
    encode zstd gzip
    php_server
}
