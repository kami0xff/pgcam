# ==============================================
# Caddyfile for pornguru.cam
# FrankenPHP behind Cloudflare Tunnel (HTTP only)
# Cloudflare handles TLS termination
# ==============================================

{
    # Global options
    frankenphp

    # Disable automatic HTTPS — Cloudflare handles TLS
    auto_https off
}

# Main domain — HTTP only (Cloudflare Tunnel connects via HTTP)
http://pornguru.cam, http://www.pornguru.cam {
    # Redirect www to non-www (Cloudflare will keep it HTTPS on the public side)
    @www host www.pornguru.cam
    redir @www https://pornguru.cam{uri} permanent

    # Document root
    root * /app/public

    # Encode responses with gzip/zstd
    encode zstd gzip

    # Security headers (HSTS is handled by Cloudflare)
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    # Handle Laravel with FrankenPHP (standard request-per-process mode)
    php_server

    # Dynamic pages - NO cache (content updates every 30 seconds)
    @dynamic {
        not path /build/* *.css *.js *.ico *.gif *.jpg *.jpeg *.png *.svg *.webp *.woff *.woff2 *.ttf *.eot
    }
    header @dynamic Cache-Control "no-cache, no-store, must-revalidate"
    header @dynamic Pragma "no-cache"

    # Build assets (versioned by Vite, cache forever)
    @build {
        path /build/*
    }
    header @build Cache-Control "public, max-age=31536000, immutable"

    # Static assets (fonts, favicons)
    @static {
        path *.ico *.woff *.woff2 *.ttf *.eot
    }
    header @static Cache-Control "public, max-age=86400"

    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
        }
        format json
    }
}

# Catch-all fallback (health checks, localhost, etc.)
:80 {
    root * /app/public
    encode zstd gzip
    php_server
}
